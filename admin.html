<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin panel ‚Äî nightbio.lol</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="admin.css">
</head>
<body class="dashboard-page admin-panel-body">
  <div class="bg-gradient"></div>
  <div class="bg-grid"></div>

  <div id="adminDenied" class="admin-denied" style="display: none;">
    <h1>Access denied</h1>
    <p id="adminDeniedReason">Access is restricted to authorized IPs.</p>
    <p id="adminDeniedHint" style="margin-top: 0.5rem; font-size: 0.9rem;"></p>
    <a href="index" class="btn btn-primary">Back to nightbio</a>
  </div>

  <div id="adminLoading" class="admin-loading">
    <p>Checking access‚Ä¶</p>
  </div>

  <div id="adminContent" style="display: none;">
    <div class="admin-layout">
      <aside class="admin-sidebar">
        <div class="admin-sidebar-brand">
          <div class="admin-sidebar-brand-icon">‚óá</div>
          <span class="admin-sidebar-brand-text">Admin</span>
        </div>
        <nav class="admin-sidebar-nav">
          <div class="admin-sidebar-nav-section">
            <div class="admin-sidebar-nav-section-title">General</div>
            <a href="#" class="admin-nav active" data-section="overview">Overview</a>
            <a href="#" class="admin-nav" data-section="analytics">Analytics</a>
            <a href="#" class="admin-nav" data-section="activity">Activity</a>
          </div>
          <div class="admin-sidebar-nav-section">
            <div class="admin-sidebar-nav-section-title">Site</div>
            <a href="#" class="admin-nav" data-section="settings">Settings</a>
            <a href="#" class="admin-nav" data-section="maintenance">Maintenance</a>
          </div>
          <div class="admin-sidebar-nav-section">
            <div class="admin-sidebar-nav-section-title">Users</div>
            <a href="#" class="admin-nav" data-section="users">All users</a>
            <a href="#" class="admin-nav" data-section="banned">Banned users</a>
            <a href="#" class="admin-nav" data-section="export">Export</a>
          </div>
          <div class="admin-sidebar-nav-section">
            <div class="admin-sidebar-nav-section-title">Security</div>
            <a href="#" class="admin-nav" data-section="security">Admins</a>
          </div>
        </nav>
        <div class="admin-sidebar-footer">
          <a href="dashboard" class="btn btn-ghost">Dashboard</a>
          <button type="button" class="btn btn-ghost" id="adminLogout">Log out</button>
        </div>
      </aside>
      <main class="admin-main">
        <header class="admin-header">
          <h2 class="admin-header-title" id="adminHeaderTitle">Overview</h2>
          <div class="admin-header-actions">
            <button type="button" class="btn btn-ghost admin-btn-refresh" id="adminRefresh" title="Refresh">‚Üª Refresh</button>
          </div>
        </header>
        <div class="admin-scroll">
          <section id="sectionOverview" class="admin-section on">
            <div class="admin-page-header">
              <h1>Overview</h1>
              <p>At a glance stats and quick actions. Use the sidebar to switch sections.</p>
              <p class="admin-meta" id="overviewLastUpdated">Data loads when you open this page or click Refresh.</p>
            </div>
            <div class="admin-stats-grid">
              <div class="admin-stat-card stat-accent">
                <div class="stat-value" id="adminUserCount">0</div>
                <div class="stat-label">Total users</div>
                <div class="stat-detail">Registered accounts</div>
              </div>
              <div class="admin-stat-card">
                <div class="stat-value" id="adminTotalViews">0</div>
                <div class="stat-label">Profile views</div>
                <div class="stat-detail">All-time page views</div>
              </div>
              <div class="admin-stat-card stat-error">
                <div class="stat-value" id="adminBannedCount">0</div>
                <div class="stat-label">Banned users</div>
                <div class="stat-detail">Blocked from sign-in</div>
              </div>
              <div class="admin-stat-card stat-success">
                <div class="stat-value" id="adminActiveCount">0</div>
                <div class="stat-label">Active users</div>
                <div class="stat-detail">Not banned</div>
              </div>
            </div>
            <div class="admin-quick-actions">
              <a href="#" class="btn btn-primary" data-section="maintenance">Maintenance mode</a>
              <a href="#" class="btn btn-ghost" data-section="users">Manage users</a>
              <a href="#" class="btn btn-ghost" data-section="banned">View banned</a>
            </div>
            <div class="admin-card">
              <div class="admin-card-header">Top 5 profiles by views</div>
              <div class="admin-card-body">
                <p class="admin-card-desc">Most-viewed bios. Click a username to open their public profile.</p>
                <ul class="admin-top-list" id="overviewTopUsers">
                  <li class="admin-empty">Loading‚Ä¶</li>
                </ul>
              </div>
            </div>
          </section>

          <section id="sectionAnalytics" class="admin-section">
            <div class="admin-page-header">
              <h1>Analytics</h1>
              <p>Ranking by total profile views. Use this to see which bios get the most traffic.</p>
            </div>
            <div class="admin-card">
              <div class="admin-card-header">Profile views ranking (top 20)</div>
              <div class="admin-card-body">
                <p class="admin-card-desc">Username links open the public bio in a new tab. Numbers are all-time views.</p>
                <ul class="admin-top-list" id="analyticsTopUsers"></ul>
              </div>
            </div>
          </section>

          <section id="sectionSettings" class="admin-section">
            <div class="admin-page-header">
              <h1>Site settings</h1>
              <p>Site name, tagline, signups, and global announcement. Changes apply across the site.</p>
            </div>
            <div class="admin-card">
              <div class="admin-card-body">
                <div class="admin-field">
                  <label for="settingsSiteName">Site name</label>
                  <input type="text" id="settingsSiteName" placeholder="nightbio" maxlength="80">
                </div>
                <div class="admin-field">
                  <label for="settingsTagline">Tagline</label>
                  <input type="text" id="settingsTagline" placeholder="Your link in one place" maxlength="120">
                </div>
                <div class="admin-field">
                  <label class="admin-checkbox-label">
                    <input type="checkbox" id="settingsAllowSignups" checked>
                    Allow new signups
                  </label>
                  <span class="admin-field-hint">When off, the signup page shows a disabled message and new users cannot register.</span>
                </div>
                <div class="admin-field">
                  <label class="admin-checkbox-label">
                    <input type="checkbox" id="settingsAnnouncementEnabled">
                    Show site-wide announcement
                  </label>
                  <textarea id="settingsAnnouncementText" rows="3" placeholder="Announcement text shown at the top of index and signup pages‚Ä¶" maxlength="500"></textarea>
                </div>
                <button type="button" class="btn btn-primary" id="settingsSave">Save settings</button>
              </div>
            </div>
          </section>

          <section id="sectionMaintenance" class="admin-section">
            <div class="admin-page-header">
              <h1>Maintenance mode</h1>
              <p>When enabled, visitors see a full-screen maintenance message instead of the site. Admins (from the allowed IP) can still open the admin panel and the site.</p>
            </div>
            <div class="admin-card">
              <div class="admin-card-body">
                <div class="admin-toggle-wrap">
                  <div id="maintenanceToggle" class="admin-toggle" role="button" tabindex="0" aria-pressed="false"></div>
                  <span id="maintenanceLabel" class="admin-toggle-label">Maintenance mode is off</span>
                </div>
                <div class="admin-field">
                  <label for="maintenanceMessage">Message shown to visitors</label>
                  <textarea id="maintenanceMessage" rows="4" placeholder="We'll be back soon. Thanks for your patience."></textarea>
                  <span class="admin-field-hint">This text is shown in the centre of the screen when maintenance is on.</span>
                </div>
                <button type="button" class="btn btn-primary" id="maintenanceSave">Save changes</button>
              </div>
            </div>
          </section>

          <section id="sectionUsers" class="admin-section">
            <div class="admin-page-header">
              <h1>All users</h1>
              <p>Search, edit profiles, grant badges, and ban or unban users. Edit opens display name, bio, and badge toggles.</p>
              <p class="admin-meta" id="usersCountLine">Showing 0 users.</p>
            </div>
            <div class="admin-toolbar">
              <div class="admin-search-wrap">
                <input type="text" id="userSearch" class="admin-search-input" placeholder="Search username, name, or email‚Ä¶" />
              </div>
              <select id="userFilter" class="admin-filter-select">
                <option value="all">All users</option>
                <option value="banned">Banned only</option>
                <option value="active">Active only</option>
              </select>
            </div>
            <div class="admin-table-wrap">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Views</th>
                    <th>Badges</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="adminUserList"></tbody>
              </table>
            </div>
          </section>

          <section id="sectionExport" class="admin-section">
            <div class="admin-page-header">
              <h1>Export users</h1>
              <p>Download the full user list as a CSV file (username, email, display name, UID #, views, joined date).</p>
            </div>
            <div class="admin-card">
              <div class="admin-card-body">
                <p class="admin-card-desc">Click to generate and download. Uses current loaded data ‚Äî click Refresh on Overview first if needed.</p>
                <button type="button" class="btn btn-primary" id="exportCsvBtn">Download CSV</button>
              </div>
            </div>
          </section>

          <section id="sectionActivity" class="admin-section">
            <div class="admin-page-header">
              <h1>Recent activity</h1>
              <p>Latest signups (by join date). Helps you see new registrations at a glance.</p>
            </div>
            <div class="admin-card">
              <div class="admin-card-header">Last 25 signups</div>
              <div class="admin-card-body">
                <ul class="admin-top-list" id="activityRecentSignups"></ul>
              </div>
            </div>
          </section>

          <section id="sectionSecurity" class="admin-section">
            <div class="admin-page-header">
              <h1>Admin access</h1>
              <p>UIDs listed here have full admin access. To add or remove admins, edit <code>adminUids</code> in Firebase Console ‚Üí Realtime Database.</p>
            </div>
            <div class="admin-card">
              <div class="admin-card-header">Current admin UIDs</div>
              <div class="admin-card-body">
                <ul class="admin-top-list" id="securityAdminList"></ul>
                <p class="admin-field-hint">To add: set <code>adminUids/&lt;uid&gt; = true</code>. To remove: delete the key. Then deploy database rules if needed.</p>
              </div>
            </div>
          </section>

          <section id="sectionBanned" class="admin-section">
            <div class="admin-page-header">
              <h1>Banned users</h1>
              <p>Users in this list are blocked from signing in. They will see &quot;Account suspended&quot; on login. Unban to restore access; they can sign in again immediately.</p>
              <p class="admin-meta" id="bannedCountLine"></p>
            </div>
            <div class="admin-card">
              <div class="admin-card-body">
                <ul class="admin-top-list" id="bannedUserList"></ul>
                <p id="bannedEmpty" class="admin-empty" style="display: none;">No banned users.</p>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <div id="editUserModal" class="admin-modal">
    <div class="admin-modal-box">
      <div class="admin-modal-header">Edit user</div>
      <div class="admin-modal-body">
        <input type="hidden" id="editUserUid" />
        <div class="admin-field">
          <label for="editDisplayName">Display name</label>
          <input type="text" id="editDisplayName" placeholder="Display name" />
        </div>
        <div class="admin-field">
          <label for="editBio">Bio</label>
          <textarea id="editBio" rows="4" placeholder="Short bio‚Ä¶"></textarea>
        </div>
        <div class="admin-field">
          <label>Badges</label>
          <div id="editBadgesList" class="admin-badges-grid"></div>
        </div>
      </div>
      <div class="admin-modal-footer">
        <button type="button" class="btn btn-ghost" id="editUserCancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="editUserSave">Save changes</button>
      </div>
    </div>
  </div>

  <div id="adminToast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script src="bio.js"></script>
  <script src="admin.js"></script>
  <script>
    (function() {
      var SECTION_TITLES = { overview: 'Overview', analytics: 'Analytics', activity: 'Activity', settings: 'Settings', maintenance: 'Maintenance', users: 'All users', banned: 'Banned users', export: 'Export', security: 'Admins' };
      var denied = document.getElementById('adminDenied');
      var reasonEl = document.getElementById('adminDeniedReason');
      var hintEl = document.getElementById('adminDeniedHint');
      var loading = document.getElementById('adminLoading');
      var content = document.getElementById('adminContent');
      var bannedSet = {};
      var hardBannedSet = {};
      var allUsers = [];
      var BADGE_KEYS = ['community', 'og', 'owner', 'staff', 'verified', 'premium'];

      function showDenied(why, hint) {
        loading.style.display = 'none';
        content.style.display = 'none';
        denied.style.display = 'block';
        if (reasonEl) reasonEl.textContent = why || 'Access denied.';
        if (hintEl) hintEl.textContent = hint || '';
      }
      function showContent() {
        loading.style.display = 'none';
        denied.style.display = 'none';
        content.style.display = 'block';
      }
      function checkIp() {
        return fetch('https://api.ipify.org?format=json').then(function(r) { return r.json(); }).then(function(d) { return d.ip; }).catch(function() { return ''; });
      }

      function showToast(msg, type) {
        type = type || 'success';
        var el = document.getElementById('adminToast');
        el.textContent = msg;
        el.className = 'admin-toast ' + type;
        el.style.display = 'block';
        clearTimeout(window._adminToastTimer);
        window._adminToastTimer = setTimeout(function() { el.style.display = 'none'; }, 3500);
      }

      function setHeaderTitle(section) {
        var t = document.getElementById('adminHeaderTitle');
        if (t) t.textContent = SECTION_TITLES[section] || 'Admin';
      }

      function switchSection(section) {
        document.querySelectorAll('.admin-nav').forEach(function(n) {
          n.classList.toggle('active', n.dataset.section === section);
        });
        document.querySelectorAll('.admin-section').forEach(function(s) {
          var id = s.id;
          var name = id.replace('section', '').toLowerCase();
          name = name.charAt(0).toLowerCase() + name.slice(1);
          s.classList.toggle('on', name === section);
        });
        setHeaderTitle(section);
        if (section === 'banned') renderBannedList();
        if (section === 'analytics') renderAnalyticsTopUsers();
        if (section === 'activity') renderActivity();
        if (section === 'settings') loadSettings();
        if (section === 'security') loadSecurity();
      }

      function getBaseUrl() {
        return (typeof window !== 'undefined' && window.location && window.location.origin)
          ? (window.location.origin + (window.location.pathname || '/').replace(/\/[^/]*$/, '/'))
          : '';
      }

      initFirebase();
      var auth = getAuth();

      document.getElementById('adminLogout').addEventListener('click', function() {
        auth.signOut().then(function() { window.location.href = 'index'; });
      });

      auth.onAuthStateChanged(function(user) {
        if (!user) {
          window.location.href = 'login?redirect=admin';
          return;
        }
        if (typeof isStaff !== 'function') {
          showDenied('Staff check not available.', '');
          return;
        }
        isStaff(user.uid).then(function(hasStaff) {
          if (hasStaff) {
            showContent();
            initPanel();
          } else {
            showDenied('Staff access required.', 'You need the Staff badge on your account. You can also use the Admin panel tab in your dashboard if you have Staff.');
          }
        }).catch(function() { showDenied('Could not verify access.', ''); });
      });

      function loadSettings() {
        getSiteConfig().then(function(c) {
          var el = document.getElementById('settingsSiteName');
          if (el) el.value = c.siteName || 'nightbio';
          el = document.getElementById('settingsTagline');
          if (el) el.value = c.tagline || '';
          el = document.getElementById('settingsAllowSignups');
          if (el) el.checked = c.allowSignups !== false;
          el = document.getElementById('settingsAnnouncementEnabled');
          if (el) el.checked = !!c.announcementEnabled;
          el = document.getElementById('settingsAnnouncementText');
          if (el) el.value = c.announcementText || '';
        }).catch(function() { showToast('Failed to load settings.', 'error'); });
      }
      function loadSecurity() {
        getAdminUids().then(function(uids) {
          var list = document.getElementById('securityAdminList');
          if (!list) return;
          if (!uids.length) {
            list.innerHTML = '<li class="admin-empty">No admin UIDs in database. Add adminUids/&lt;your-uid&gt; = true in Firebase Console.</li>';
            return;
          }
          list.innerHTML = uids.map(function(uid) {
            return '<li><code class="admin-uid-code">' + escapeHtml(uid) + '</code></li>';
          }).join('');
        }).catch(function() { showToast('Failed to load admins.', 'error'); });
      }
      function renderActivity() {
        var list = (allUsers || []).slice().filter(function(u) { return u.createdAt != null; }).sort(function(a, b) { return (b.createdAt || 0) - (a.createdAt || 0); }).slice(0, 25);
        var el = document.getElementById('activityRecentSignups');
        if (!el) return;
        if (!list.length) {
          el.innerHTML = '<li class="admin-empty">No signups with join date yet, or data not loaded. Refresh Overview first.</li>';
          return;
        }
        var base = getBaseUrl();
        el.innerHTML = list.map(function(u) {
          var date = u.createdAt ? (typeof u.createdAt === 'number' ? new Date(u.createdAt).toLocaleString() : String(u.createdAt)) : '‚Äî';
          var link = base ? '<a href="' + base + 'bio?u=' + encodeURIComponent(u.username) + '" target="_blank" rel="noopener" style="color: var(--purple-accent);">' + escapeHtml(u.username || '‚Äî') + '</a>' : escapeHtml(u.username || '‚Äî');
          return '<li><span class="name">' + link + '</span> <span class="admin-activity-date">' + escapeHtml(date) + '</span></li>';
        }).join('');
      }
      function exportCsv() {
        var rows = [['Username', 'Email', 'Display name', 'UID', 'Views', 'Joined']];
        (allUsers || []).forEach(function(u) {
          var joined = u.createdAt ? (typeof u.createdAt === 'number' ? new Date(u.createdAt).toISOString() : String(u.createdAt)) : '';
          rows.push([
            (u.username || '').replace(/"/g, '""'),
            (u.email || '').replace(/"/g, '""'),
            (u.displayName || '').replace(/"/g, '""'),
            u.userId != null ? u.userId : '',
            (u.stats && u.stats.views) || 0,
            joined
          ]);
        });
        var csv = rows.map(function(r) { return r.map(function(c) { return '"' + c + '"'; }).join(','); }).join('\n');
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'nightbio-users-' + (new Date().toISOString().slice(0, 10)) + '.csv';
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('CSV downloaded.');
      }

      function initPanel() {
        loadOverview();
        loadMaintenance();

        document.querySelectorAll('.admin-nav').forEach(function(a) {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            switchSection(this.dataset.section);
          });
        });
        document.querySelectorAll('.admin-quick-actions [data-section]').forEach(function(a) {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            switchSection(this.dataset.section);
          });
        });

        document.getElementById('adminRefresh').addEventListener('click', function() {
          loadOverview();
          loadMaintenance();
          loadSettings();
          showToast('Data refreshed.');
        });

        document.getElementById('maintenanceToggle').addEventListener('click', function() {
          this.classList.toggle('on');
          this.setAttribute('aria-pressed', this.classList.contains('on'));
          document.getElementById('maintenanceLabel').textContent = this.classList.contains('on') ? 'Maintenance mode is on' : 'Maintenance mode is off';
        });
        document.getElementById('maintenanceSave').addEventListener('click', function() {
          var on = document.getElementById('maintenanceToggle').classList.contains('on');
          var msg = document.getElementById('maintenanceMessage').value.trim() || 'We\'ll be back soon.';
          setMaintenanceMode(on, msg).then(function() {
            showToast('Maintenance settings saved.');
            loadMaintenance();
          }).catch(function() { showToast('Failed to save.', 'error'); });
        });

        document.getElementById('userSearch').addEventListener('input', function() { renderUserTable(allUsers, bannedSet, hardBannedSet); });
        document.getElementById('userFilter').addEventListener('change', function() { renderUserTable(allUsers, bannedSet, hardBannedSet); });

        document.getElementById('editUserCancel').addEventListener('click', function() {
          document.getElementById('editUserModal').classList.remove('on');
        });
        document.getElementById('editUserModal').addEventListener('click', function(e) {
          if (e.target === this) this.classList.remove('on');
        });
        document.getElementById('editUserSave').addEventListener('click', saveEditUser);

        document.getElementById('settingsSave').addEventListener('click', function() {
          var siteName = document.getElementById('settingsSiteName').value.trim() || 'nightbio';
          var tagline = document.getElementById('settingsTagline').value.trim();
          var allowSignups = document.getElementById('settingsAllowSignups').checked;
          var announcementEnabled = document.getElementById('settingsAnnouncementEnabled').checked;
          var announcementText = document.getElementById('settingsAnnouncementText').value.trim();
          setSiteConfig({ siteName: siteName, tagline: tagline, allowSignups: allowSignups, announcementEnabled: announcementEnabled, announcementText: announcementText }).then(function() {
            showToast('Settings saved.');
            loadSettings();
          }).catch(function() { showToast('Failed to save settings.', 'error'); });
        });
        var exportBtn = document.getElementById('exportCsvBtn');
        if (exportBtn) exportBtn.addEventListener('click', exportCsv);
      }

      function loadOverview() {
        Promise.all([getAllUsers(), getBannedUids().catch(function() { return {}; }), getHardBannedUids().catch(function() { return {}; })]).then(function(res) {
          var users = res[0];
          var banned = res[1] || {};
          var hardBanned = res[2] || {};
          allUsers = users;
          bannedSet = banned;
          hardBannedSet = hardBanned;
          var bannedCount = Object.keys(banned).filter(function(k) { return banned[k]; }).length;
          document.getElementById('adminUserCount').textContent = users.length.toLocaleString();
          var totalViews = 0;
          users.forEach(function(u) { totalViews += (u.stats && u.stats.views) || 0; });
          document.getElementById('adminTotalViews').textContent = totalViews.toLocaleString();
          document.getElementById('adminBannedCount').textContent = bannedCount;
          document.getElementById('adminActiveCount').textContent = (users.length - bannedCount).toLocaleString();
          var metaEl = document.getElementById('overviewLastUpdated');
          if (metaEl) metaEl.textContent = 'Last updated: ' + new Date().toLocaleString();
          renderUserTable(users, banned, hardBanned);
          renderOverviewTopUsers(users);
          renderAnalyticsTopUsers();
          renderBannedList();
        }).catch(function(err) {
          console.error(err);
          renderUserTable([], {}, {});
          var msg = (err && err.message) ? ('Failed to load users: ' + err.message) : 'Failed to load users.';
          var uid = auth.currentUser && auth.currentUser.uid;
          if (uid) msg += '\n\nYour UID: ' + uid + '\nAdd adminUids/' + uid + ' = true in Realtime Database, then run: firebase deploy --only database';
          showToast(msg, 'error');
          alert(msg);
        });
      }

      function loadMaintenance() {
        getSiteConfig().then(function(c) {
          var t = document.getElementById('maintenanceToggle');
          var l = document.getElementById('maintenanceLabel');
          var m = document.getElementById('maintenanceMessage');
          t.classList.toggle('on', c.maintenanceMode);
          t.setAttribute('aria-pressed', c.maintenanceMode);
          l.textContent = c.maintenanceMode ? 'Maintenance mode is on' : 'Maintenance mode is off';
          m.value = c.maintenanceMessage || '';
        }).catch(function() {});
      }

      function loadUsers() {
        Promise.all([getBannedUids().catch(function() { return {}; }), getHardBannedUids().catch(function() { return {}; })]).then(function(res) {
          bannedSet = res[0] || {};
          hardBannedSet = res[1] || {};
          var users = allUsers.length ? allUsers : [];
          if (!users.length) return getAllUsers().then(function(u) { allUsers = u; renderUserTable(u, bannedSet, hardBannedSet); });
          renderUserTable(users, bannedSet, hardBannedSet);
        }).catch(function() {
          if (allUsers.length) renderUserTable(allUsers, bannedSet, hardBannedSet);
        });
      }

      function getFilteredList(users, banned) {
        var search = (document.getElementById('userSearch').value || '').toLowerCase().trim();
        var filter = (document.getElementById('userFilter').value || 'all');
        var list = users;
        if (search) {
          list = users.filter(function(u) {
            return (u.username || '').toLowerCase().indexOf(search) !== -1 ||
              (u.displayName || '').toLowerCase().indexOf(search) !== -1 ||
              (u.email || '').toLowerCase().indexOf(search) !== -1;
          });
        }
        if (filter === 'banned') list = list.filter(function(u) { return banned && banned[u.uid]; });
        if (filter === 'active') list = list.filter(function(u) { return !banned || !banned[u.uid]; });
        return list;
      }

      function renderOverviewTopUsers(users) {
        var list = (users || []).slice().sort(function(a, b) {
          var va = (a.stats && a.stats.views) || 0;
          var vb = (b.stats && b.stats.views) || 0;
          return vb - va;
        }).slice(0, 5);
        var el = document.getElementById('overviewTopUsers');
        if (!el) return;
        if (list.length === 0) {
          el.innerHTML = '<li class="admin-empty"><span class="admin-empty-icon">üìä</span><br>No profile views yet.</li>';
          return;
        }
        var base = getBaseUrl();
        el.innerHTML = list.map(function(u, i) {
          var views = (u.stats && u.stats.views) || 0;
          var uidTitle = 'UID ' + (u.userId != null ? u.userId : (u.uid || ''));
          var link = base ? '<a href="' + base + 'bio?u=' + encodeURIComponent(u.username) + '" target="_blank" rel="noopener" style="color: var(--purple-accent);" title="' + escapeHtml(uidTitle) + '">' + escapeHtml(u.username || '‚Äî') + '</a>' : escapeHtml(u.username || '‚Äî');
          return '<li title="' + escapeHtml(uidTitle) + '"><span class="rank">' + (i + 1) + '</span><span class="name">' + link + '</span><span class="value">' + views.toLocaleString() + ' views</span></li>';
        }).join('');
      }

      function renderAnalyticsTopUsers() {
        var list = (allUsers || []).slice().sort(function(a, b) {
          var va = (a.stats && a.stats.views) || 0;
          var vb = (b.stats && b.stats.views) || 0;
          return vb - va;
        }).slice(0, 20);
        var el = document.getElementById('analyticsTopUsers');
        if (!el) return;
        if (list.length === 0) {
          el.innerHTML = '<li class="admin-empty"><span class="admin-empty-icon">üìà</span><br>No data yet.</li>';
          return;
        }
        var base = getBaseUrl();
        el.innerHTML = list.map(function(u, i) {
          var views = (u.stats && u.stats.views) || 0;
          var uidTitle = 'UID ' + (u.userId != null ? u.userId : (u.uid || ''));
          var link = base ? '<a href="' + base + 'bio?u=' + encodeURIComponent(u.username) + '" target="_blank" rel="noopener" style="color: var(--purple-accent);" title="' + escapeHtml(uidTitle) + '">' + escapeHtml(u.username || '‚Äî') + '</a>' : escapeHtml(u.username || '‚Äî');
          return '<li title="' + escapeHtml(uidTitle) + '"><span class="rank">' + (i + 1) + '</span><span class="name">' + link + '</span><span class="value">' + views.toLocaleString() + '</span></li>';
        }).join('');
      }

      function renderBannedList() {
        var list = allUsers.filter(function(u) { return bannedSet && bannedSet[u.uid]; });
        var ul = document.getElementById('bannedUserList');
        var empty = document.getElementById('bannedEmpty');
        var countLine = document.getElementById('bannedCountLine');
        if (countLine) countLine.textContent = list.length === 0 ? '0 banned users.' : list.length + ' banned user' + (list.length !== 1 ? 's' : '') + '.';
        if (!ul) return;
        if (list.length === 0) {
          ul.innerHTML = '';
          if (empty) empty.style.display = 'block';
          return;
        }
        if (empty) empty.style.display = 'none';
        var html = list.map(function(u) {
          var rawEmail = u.email || '';
          var emailPart = rawEmail ? ('<span class="admin-email-text" data-email="' + escapeHtml(rawEmail) + '" data-masked="' + escapeHtml(maskEmail(rawEmail)) + '">' + escapeHtml(maskEmail(rawEmail)) + '</span>') : '';
          return '<li><span class="name">' + escapeHtml(u.username || u.uid) + (emailPart ? ' ‚Äî ' + emailPart : '') + '</span>' + (rawEmail ? '<button type="button" class="btn-icon admin-email-reveal" aria-label="Reveal email" title="Reveal email">üëÅ</button>' : '') + '<button type="button" class="btn btn-ghost unban-list-btn" data-uid="' + escapeHtml(u.uid) + '" style="font-size: 0.85rem;">Unban</button></li>';
        }).join('');
        ul.innerHTML = html;
        ul.querySelectorAll('.unban-list-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            unbanUser(btn.dataset.uid).then(function() {
              showToast('User unbanned.');
              loadOverview();
              renderBannedList();
            }).catch(function() { showToast('Failed to unban.', 'error'); });
          });
        });
        ul.querySelectorAll('.admin-email-reveal').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var row = btn.closest('li');
            if (!row) return;
            var span = row.querySelector('.admin-email-text');
            if (!span) return;
            var full = span.dataset.email || '';
            var masked = span.dataset.masked || '***';
            var isRevealed = span.getAttribute('data-revealed') === '1';
            if (isRevealed) {
              span.textContent = masked;
              span.setAttribute('data-revealed', '0');
              btn.setAttribute('aria-label', 'Reveal email');
              btn.setAttribute('title', 'Reveal email');
            } else {
              span.textContent = full;
              span.setAttribute('data-revealed', '1');
              btn.setAttribute('aria-label', 'Hide email');
              btn.setAttribute('title', 'Hide email');
            }
          });
        });
      }

      function renderUserTable(users, banned, hardBanned) {
        banned = banned || {};
        hardBanned = hardBanned || {};
        var list = getFilteredList(users || [], banned);
        var total = (users || []).length;
        var countLine = document.getElementById('usersCountLine');
        if (countLine) {
          if (list.length === total) countLine.textContent = 'Showing ' + total + ' user' + (total !== 1 ? 's' : '') + '.';
          else countLine.textContent = 'Showing ' + list.length + ' of ' + total + ' users.';
        }
        var tbody = document.getElementById('adminUserList');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!list.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="admin-empty">No users match.</td></tr>';
          return;
        }
        var base = getBaseUrl();
        list.forEach(function(u) {
          var badges = u.badges || {};
          var badgeHtml = BADGE_KEYS.map(function(k) {
            return '<span class="badge-pill ' + (badges[k] ? 'on' : '') + '" title="' + k + '">' + k.charAt(0).toUpperCase() + '</span>';
          }).join('');
          var isBanned = !!(banned && banned[u.uid]);
          var isHardBanned = !!(hardBanned && hardBanned[u.uid]);
          var profileUrl = base ? base + 'bio?u=' + encodeURIComponent(u.username) : '#';
          var uidTitle = 'UID ' + (u.userId != null ? u.userId : (u.uid || ''));
          var rawEmail = u.email || '';
          var emailDisplay = rawEmail ? ('<span class="admin-email-text" data-email="' + escapeHtml(rawEmail) + '" data-masked="' + escapeHtml(maskEmail(rawEmail)) + '">' + escapeHtml(maskEmail(rawEmail)) + '</span>') : '‚Äî';
          var actions = '<button type="button" class="btn-icon edit-user-btn" data-uid="' + escapeHtml(u.uid) + '" title="Edit">‚úé</button>' +
            '<a href="' + profileUrl + '" target="_blank" rel="noopener" class="btn-icon" title="View profile">‚Üó</a>' +
            (rawEmail ? '<button type="button" class="btn-icon admin-email-reveal" aria-label="Reveal email" title="Reveal email">üëÅ</button>' : '');
          if (isBanned) {
            actions += '<button type="button" class="btn-icon unban-btn" data-uid="' + escapeHtml(u.uid) + '" title="Unban">‚Ü©</button>';
            if (isHardBanned) actions += '<button type="button" class="btn-icon danger-outline remove-ip-ban-btn" data-uid="' + escapeHtml(u.uid) + '" title="Remove IP ban">IP</button>';
          } else {
            actions += '<button type="button" class="btn-icon danger ban-btn" data-uid="' + escapeHtml(u.uid) + '" title="Ban">‚äó</button>';
            actions += '<button type="button" class="btn-icon danger hard-ban-btn" data-uid="' + escapeHtml(u.uid) + '" title="Hard ban (ban account + IP)">‚äõ</button>';
          }
          actions += '<button type="button" class="btn-icon danger-outline delete-account-btn" data-uid="' + escapeHtml(u.uid) + '" title="Delete account">‚å´</button>';
          var tr = document.createElement('tr');
          tr.title = uidTitle;
          tr.innerHTML =
            '<td><span class="user-name" title="' + escapeHtml(uidTitle) + '">' + escapeHtml(u.displayName || u.username || '‚Äî') + '</span></td>' +
            '<td><a href="' + profileUrl + '" target="_blank" rel="noopener" style="color: var(--purple-accent);" title="' + escapeHtml(uidTitle) + '">' + escapeHtml(u.username || '‚Äî') + '</a></td>' +
            '<td class="admin-email-cell">' + emailDisplay + '</td>' +
            '<td>' + ((u.stats && u.stats.views) || 0).toLocaleString() + '</td>' +
            '<td>' + badgeHtml + '</td>' +
            '<td>' + (isBanned ? '<span class="badge-pill badge-banned">' + (isHardBanned ? 'Hard banned' : 'Banned') + '</span>' : '<span class="badge-pill">Active</span>') + '</td>' +
            '<td class="actions">' + actions + '</td>';
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('.edit-user-btn').forEach(function(btn) {
          btn.addEventListener('click', function() { openEditModal(btn.dataset.uid); });
        });
        tbody.querySelectorAll('.ban-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            if (!confirm('Ban this user? They will not be able to sign in.')) return;
            banUser(btn.dataset.uid).then(function() {
              showToast('User banned.');
              loadUsers();
              loadOverview();
            }).catch(function() { showToast('Failed to ban.', 'error'); });
          });
        });
        tbody.querySelectorAll('.hard-ban-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            if (!confirm('Hard ban: ban this user AND their IP so they cannot create new accounts. Continue?')) return;
            hardBanUser(btn.dataset.uid).then(function() {
              showToast('User and IP banned.');
              loadUsers();
              loadOverview();
            }).catch(function(err) {
              showToast(err && err.message ? err.message : 'Failed to hard ban (user may have no IP on file).', 'error');
            });
          });
        });
        tbody.querySelectorAll('.unban-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            unbanUser(btn.dataset.uid).then(function() {
              showToast('User unbanned.');
              loadUsers();
              loadOverview();
            }).catch(function() { showToast('Failed to unban.', 'error'); });
          });
        });
        tbody.querySelectorAll('.remove-ip-ban-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            if (!confirm('Remove IP ban for this user? They will be able to create new accounts from this IP again. Account ban is unchanged.')) return;
            removeIPBan(btn.dataset.uid).then(function() {
              showToast('IP ban removed.');
              loadUsers();
              loadOverview();
            }).catch(function() { showToast('Failed to remove IP ban.', 'error'); });
          });
        });
        tbody.querySelectorAll('.admin-email-reveal').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var row = btn.closest('tr');
            if (!row) return;
            var span = row.querySelector('.admin-email-text');
            if (!span) return;
            var full = span.dataset.email || '';
            var masked = span.dataset.masked || '***';
            var isRevealed = span.getAttribute('data-revealed') === '1';
            if (isRevealed) {
              span.textContent = masked;
              span.setAttribute('data-revealed', '0');
              btn.setAttribute('aria-label', 'Reveal email');
              btn.setAttribute('title', 'Reveal email');
            } else {
              span.textContent = full;
              span.setAttribute('data-revealed', '1');
              btn.setAttribute('aria-label', 'Hide email');
              btn.setAttribute('title', 'Hide email');
            }
          });
        });
        tbody.querySelectorAll('.delete-account-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            if (!confirm('Permanently delete this user\'s bio and data? Their link will stop working. Their login account will still exist but they will have no profile.')) return;
            deleteUserAccount(btn.dataset.uid).then(function() {
              showToast('User account data deleted.');
              loadUsers();
              loadOverview();
            }).catch(function() { showToast('Failed to delete account.', 'error'); });
          });
        });
      }

      function escapeHtml(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function maskEmail(email) {
        if (!email || typeof email !== 'string') return '';
        var e = email.trim();
        var at = e.indexOf('@');
        if (at <= 0 || at >= e.length - 1) return '***';
        var local = e.slice(0, at);
        var domain = e.slice(at + 1);
        var maskedLocal = local.length <= 2 ? (local.charAt(0) + '*') : (local.charAt(0) + '***' + local.charAt(local.length - 1));
        var dot = domain.indexOf('.');
        var maskedDomain = dot <= 0 ? '***' : (domain.charAt(0) + '***' + domain.slice(dot));
        return maskedLocal + '@' + maskedDomain;
      }

      function openEditModal(uid) {
        document.getElementById('editUserUid').value = uid;
        getCurrentUserBio(uid).then(function(data) {
          if (!data) return;
          document.getElementById('editDisplayName').value = data.displayName || '';
          document.getElementById('editBio').value = data.bio || '';
          var badges = data.badges || {};
          var listEl = document.getElementById('editBadgesList');
          listEl.innerHTML = '';
          BADGE_KEYS.forEach(function(k) {
            var label = document.createElement('label');
            label.innerHTML = '<input type="checkbox" class="edit-badge-cb" data-badge="' + k + '" ' + (badges[k] ? 'checked' : '') + '> ' + k;
            listEl.appendChild(label);
          });
          document.getElementById('editUserModal').classList.add('on');
        }).catch(function() { showToast('Could not load user.', 'error'); });
      }

      function saveEditUser() {
        var uid = document.getElementById('editUserUid').value;
        if (!uid) return;
        var data = {
          displayName: document.getElementById('editDisplayName').value,
          bio: document.getElementById('editBio').value,
          badges: {}
        };
        document.querySelectorAll('.edit-badge-cb').forEach(function(cb) {
          data.badges[cb.dataset.badge] = cb.checked;
        });
        adminUpdateUserProfile(uid, data).then(function() {
          document.getElementById('editUserModal').classList.remove('on');
          loadUsers();
          loadOverview();
          showToast('User updated.');
        }).catch(function() { showToast('Failed to save.', 'error'); });
      }
    })();
  </script>
</body>
</html>
